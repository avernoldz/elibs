<!-- Include QuaggaJS Library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

<!-- QR Code Scanner Section -->
<div class="content-wrapper-scroll">
    <div class="content-wrapper">
        <div class="row">
            <div class="col-sm-12 col-12">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">Book Return</div>
                    </div>
                    <div class="card-body">

                        <!-- Book Return Form and QR Scanner -->
                        <div class="row">
                            <!-- Left Section for Manual Input -->
                            <div class="col-sm-6 col-12">
                                <div class="mb-3">
                                    <label class="form-label">First Name</label>
                                    <input type="text" class="form-control" placeholder="Enter First Name" value="">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Last Name</label>
                                    <input type="text" class="form-control" placeholder="Enter Last Name" value="">
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Book ID (QR Code Scanned or Manual Entry)</label>
                                    <input type="text" id="book-id" class="form-control" placeholder="Scanned Book ID" readonly>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Return Date</label>
                                    <input type="date" class="form-control">
                                </div>
                                <div class="book-details mt-3">
                                    <h5>Book Details:</h5>
                                    <p id="book-title">Title: <span>-</span></p>
                                    <p id="book-author">Author: <span>-</span></p>
                                    <p id="book-due-date">Due Date: <span>-</span></p>
                                    <p id="book-fine">Fine: <span>-</span></p>
                                </div>
                            </div>

                            <!-- Right Section for QR Code Scanner -->
                            <div class="col-sm-6 col-12">
                                <div class="mb-3">
                                    <label class="form-label">Scan QR Code</label>
                                    <div id="scanner-container" style="position: relative; width: 100%; height: 300px; border: 1px solid #ccc;">
                                        <video id="scanner-video" style="width: 100%; height: 100%;"></video>
                                    </div>
                                    <button id="start-scanner" class="btn btn-primary mt-2">Start Scanner</button>
                                    <button id="stop-scanner" class="btn btn-danger mt-2" style="display: none;">Stop Scanner</button>
                                </div>
                            </div>
                        </div>

                        <!-- Buttons and Submission -->
                        <div class="row">
                            <div class="col-12">
                                <button class="btn btn-success btn-lg" id="submit-return">Submit Return</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- JS for QuaggaJS Integration with API Call -->
        <script>
            document.addEventListener('DOMContentLoaded', function () {
                const BASE_API_URL = "https://example.com/api"; // Replace with your actual API base URL
                const startScannerButton = document.getElementById('start-scanner');
                const stopScannerButton = document.getElementById('stop-scanner');
                const bookIdInput = document.getElementById('book-id');
                const submitReturnButton = document.getElementById('submit-return');

                // Display Book Details
                const bookTitle = document.getElementById('book-title').querySelector('span');
                const bookAuthor = document.getElementById('book-author').querySelector('span');
                const bookDueDate = document.getElementById('book-due-date').querySelector('span');
                const bookFine = document.getElementById('book-fine').querySelector('span');

                // Fetch Book Details from API
                function fetchBookDetails(bookId) {
                    fetch(`${BASE_API_URL}/books/${bookId}`)
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`API responded with status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.success) {
                                const book = data.data;
                                bookTitle.textContent = book.title || "N/A";
                                bookAuthor.textContent = book.author || "N/A";
                                bookDueDate.textContent = book.due_date || "N/A";
                                bookFine.textContent = `$${book.fine || "0.00"}`;
                            } else {
                                alert('Book details not found.');
                                resetBookDetails();
                            }
                        })
                        .catch(error => {
                            console.error('Error fetching book details:', error);
                            alert('Failed to fetch book details. Please try again.');
                        });
                }

                // Reset Book Details
                function resetBookDetails() {
                    bookTitle.textContent = '-';
                    bookAuthor.textContent = '-';
                    bookDueDate.textContent = '-';
                    bookFine.textContent = '-';
                }

                // Start the scanner
                startScannerButton.addEventListener('click', function () {
                    Quagga.init({
                        inputStream: {
                            name: "Live",
                            type: "LiveStream",
                            target: document.getElementById('scanner-container'),
                            constraints: {
                                width: 640,
                                height: 480,
                                facingMode: "environment"
                            },
                        },
                        decoder: {
                            readers: ["qr_reader"] // Include QR reader only
                        }
                    }, function (err) {
                        if (err) {
                            console.error(err);
                            alert("Failed to start scanner.");
                            return;
                        }
                        Quagga.start();
                        startScannerButton.style.display = "none";
                        stopScannerButton.style.display = "block";
                    });
                });

                // Stop the scanner
                stopScannerButton.addEventListener('click', function () {
                    Quagga.stop();
                    startScannerButton.style.display = "block";
                    stopScannerButton.style.display = "none";
                });

                // Process the scanned result
                Quagga.onDetected(function (result) {
                    const code = result.codeResult.code;
                    console.log("Scanned Code: ", code);
                    bookIdInput.value = code; // Populate the Book ID field
                    fetchBookDetails(code); // Fetch book details using API
                    Quagga.stop(); // Automatically stop the scanner
                    startScannerButton.style.display = "block";
                    stopScannerButton.style.display = "none";
                });

                // Handle the return submission
                submitReturnButton.addEventListener('click', function () {
                    const bookId = bookIdInput.value;
                    if (bookId.trim() === '') {
                        alert('Please scan or enter the book ID.');
                        return;
                    }

                    // Submit return logic (e.g., call backend API to process return)
                    alert(`Book ID: ${bookId} returned successfully!`);
                });
            });
        </script>
    </div>
</div>
